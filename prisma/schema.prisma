generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  PROFESSIONAL
  CUSTOMER
}

enum QuestionType {
  CUSTOMER
  PROFESSIONAL
  PROFILE_FAQ
}

enum QuestionInputType {
  TEXT
  SINGLE_CHOICE
  MULTIPLE_CHOICE
}

enum CompanySize {
  SOLO
  SMALL_TEAM // 2-10 employees
  MEDIUM_TEAM // 11-50 employees
  LARGE_TEAM // 51+ employees
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum LeadAssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  MISSED
}

enum NotificationType {
  // For Professionals
  LEAD_ASSIGNED
  LEAD_ACCEPTED_BY_OTHER
  WALLET_TOPUP
  WELCOME_PRO

  // For Admins
  NEW_LEAD_FOR_ASSIGNMENT
  LEAD_REJECTED_BY_PRO
  ISSUE_REPORTED_BY_CUSTOMER
  NEW_PROFESSIONAL_SIGNUP
}

enum BundleTag {
  BASIC
  STANDARD
  PREMIUM
  PLATINUM
}

model User {
  id                 String     @id @default(cuid())
  email              String     @unique
  name               String?
  password           String
  role               UserRole   @default(CUSTOMER)
  status             UserStatus @default(ACTIVE)
  onboardingComplete Boolean    @default(false)
  phoneNumber        String?    @map("phone_number")
  address            String?

  professionalProfile ProfessionalProfile?
  postedLeads         Lead[]               @relation("CustomerLeads")
  transactions        Transaction[]
  customerRequests    CustomerRequest[]
  bookings            Booking[]
  reviewsGiven        Review[]             @relation("CustomerReviews")
  reviewsReceived     Review[]             @relation("ProfessionalReviews")
  professionalAnswers ProfessionalAnswer[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  CreditPurchase      CreditPurchase[]
  LeadAssignment      LeadAssignment[]
  Lead                Lead[]
  notifications       Notification[]
  customerSupport     CustomerSupport[]    @relation("CustomerSupportTickets")

  @@map("users")
}

model CreditPackage {
  id             String           @id @default(cuid())
  name           String
  description    String?
  credits        Int
  price          Float
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  CreditPurchase CreditPurchase[]
}

model CreditPurchase {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  creditPackageId String
  creditPackage   CreditPackage @relation(fields: [creditPackageId], references: [id])
  amountPaid      Float
  transactionId   String        @unique
  purchasedAt     DateTime      @default(now())
}

model ProfessionalProfile {
  id                 String                 @id @default(cuid())
  userId             String                 @unique
  user               User                   @relation(fields: [userId], references: [id])
  credits            Int                    @default(0)
  companyName        String?
  companyLogoUrl     String?
  profilePictureUrl  String?
  companyEmail       String?
  companyPhoneNumber String?
  websiteUrl         String?
  locations          ProfessionalLocation[]

  companySize CompanySize? @default(SOLO)
  yearFounded Int?
  bio         String?      @db.Text

  photos      ProfilePhoto[]
  socialMedia Json?

  phoneNumber         String?
  isVerified          Boolean   @default(false)
  services            Service[] @relation("ProfessionalServices")
  bookings            Booking[]
  notifyOnNewLead     Boolean   @default(true)
  notifyOnNewMessage  Boolean   @default(true)
  notifyOnPayment     Boolean   @default(true)
  notifyWeeklySummary Boolean   @default(false)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model ProfessionalLocation {
  id           String  @id @default(cuid())
  postcode     String
  locationName String
  isPrimary    Boolean @default(false)

  profileId String
  profile   ProfessionalProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, postcode])
}

model ProfilePhoto {
  id        String              @id @default(cuid())
  url       String?
  caption   String?
  profileId String
  profile   ProfessionalProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  createdAt DateTime            @default(now())
}

model ProfessionalAnswer {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  questionId String
  question   Question @relation(fields: [questionId], references: [id])
  answerText String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, questionId])
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  services    Service[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Service {
  id               String                @id @default(cuid())
  name             String
  description      String?
  creditCost       Int?
  imageUrl         String?
  isActive         Boolean               @default(true)
  categoryId       String
  category         Category              @relation(fields: [categoryId], references: [id])
  professionals    ProfessionalProfile[] @relation("ProfessionalServices")
  questions        Question[]
  customerRequests CustomerRequest[]
  leads            Lead[]
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
}

model Question {
  id        String               @id @default(cuid())
  text      String
  order     Int
  type      QuestionType         @default(CUSTOMER)
  inputType QuestionInputType    @default(SINGLE_CHOICE)
  serviceId String
  service   Service              @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  options   Option[]
  answers   ProfessionalAnswer[]
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
}

model Option {
  id         String   @id @default(cuid())
  text       String
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model CustomerRequest {
  id         String   @id @default(cuid())
  customerId String
  customer   User     @relation(fields: [customerId], references: [id])
  serviceId  String
  service    Service  @relation(fields: [serviceId], references: [id])
  postcode   String
  answers    Json
  status     String   @default("open")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  Booking    Booking?
}

model Booking {
  id                String              @id @default(cuid())
  customerRequestId String              @unique
  request           CustomerRequest     @relation(fields: [customerRequestId], references: [id])
  customerId        String
  customer          User                @relation(fields: [customerId], references: [id])
  professionalId    String
  professional      ProfessionalProfile @relation(fields: [professionalId], references: [id])
  bookingTime       DateTime
  status            String
  creditsCharged    Int
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?  @db.Text
  createdAt DateTime @default(now())

  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  customerId String
  customer   User   @relation("CustomerReviews", fields: [customerId], references: [id], onDelete: Cascade)

  professionalId String
  professional   User   @relation("ProfessionalReviews", fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([leadId, professionalId, customerId])
}

model CustomerSupport {
  id        String   @id @default(cuid())
  issue     String   @db.Text
  status    String   @default("PENDING") // PENDING, IN_PROGRESS, RESOLVED
  type      String // REFUND_REQUEST, GENERAL_INQUIRY
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customerId String
  customer   User   @relation("CustomerSupportTickets", fields: [customerId], references: [id], onDelete: Cascade)

  leadId String?
  lead   Lead?   @relation(fields: [leadId], references: [id])
}

model CreditBundle {
  id           String        @id @default(cuid())
  name         String
  description  String?
  price        Float
  credits      Int
  currency     String        @default("INR")
  isActive     Boolean       @default(true)
  tag          BundleTag? 
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Lead {
  id          String   @id @default(cuid())
  title       String
  description String
  location    String
  budget      String?
  urgency     String
  status      String   @default("OPEN")
  answers     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])

  customerId String
  customer   User   @relation("CustomerLeads", fields: [customerId], references: [id])

  assignments     LeadAssignment[]
  reviews         Review[]
  customerSupport CustomerSupport[]

  User   User?   @relation(fields: [userId], references: [id])
  userId String?

  @@index([customerId])
  @@index([serviceId])
}

model LeadAssignment {
  id             String               @id @default(cuid())
  leadId         String
  lead           Lead                 @relation(fields: [leadId], references: [id], onDelete: Cascade)
  professionalId String
  professional   User                 @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  status         LeadAssignmentStatus @default(PENDING)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  @@unique([leadId, professionalId])
  @@index([leadId])
  @@index([professionalId])
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PaymentProvider {
  PHONEPE
  STRIPE
  RAZORPAY
}

model Transaction {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  bundleId String?
  bundle   CreditBundle? @relation(fields: [bundleId], references: [id])

  amount  Float
  credits Int

  status                TransactionStatus @default(PENDING)
  provider              PaymentProvider
  merchantTransactionId String            @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Configuration {
  key   String @id
  value String
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  message   String
  read      Boolean  @default(false)
  data      Json? // Additional context data
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}
